<!-- Generated by spec-lite v0.0.4 | sub-agent: feature | date: 2026-02-21 -->

# Feature: ArenaStorageService

## 1. Feature Goal

**ID**: FEAT-001

Provide a persistent, on-disk storage backend for all Arena AI chat data — sessions, messages,
references, provider settings, arena settings, and document metadata — under the conventional
`.waveclient/arena/` directory. This unblocks the migration of all Arena I/O from the webview
to the VS Code extension host, and ensures Arena state survives webview reloads and VS Code
restarts without any data loss.

---

## 2. Data Model (Granular)

### Entities & Attributes

**`ArenaSession`** (imported from `@wave-client/core`):
- `id` (`string`) — UUID, primary identifier. NOT NULL.
- `title` (`string`) — User-visible session title. NOT NULL.
- `agent` (`ArenaAgentId`) — Which agent handles this session (`'wave-client'` | `'web-expert'`). NOT NULL.
- `createdAt` (`number`) — Unix timestamp (ms). NOT NULL.
- `updatedAt` (`number`) — Unix timestamp (ms), updated on every message save. NOT NULL.
- `messageCount` (`number`) — Denormalised count; updated by the caller after message saves. NOT NULL, DEFAULT `0`.
- `metadata?` (`ArenaSessionMetadata`) — Token count, provider, model, duration. Optional.

**`ArenaMessage`** (imported from `@wave-client/core`):
- `id` (`string`) — UUID. NOT NULL.
- `sessionId` (`string`) — Parent session ID. NOT NULL. Implicit FK to `ArenaSession.id`.
- `role` (`ArenaMessageRole`) — `'user'` | `'assistant'` | `'tool'` | `'system'`. NOT NULL.
- `content` (`string`) — Raw message text. NOT NULL.
- `status` (`ArenaMessageStatus`) — `'pending'` | `'streaming'` | `'complete'` | `'error'`. NOT NULL.
- `timestamp` (`number`) — Unix timestamp (ms). NOT NULL.
- `command?` (`ArenaCommandId`) — Optional triggering slash command.
- `tokenCount?` (`number`) — Estimated token count.
- `error?` (`string`) — Error message when status is `'error'`.
- `sources?` (`ArenaMessageSource[]`) — Citations / references used.
- `blocks?` (`ArenaChatBlock[]`) — Rich UI blocks (rendered instead of `content` when present).

**`ArenaDocument`** (imported from `@wave-client/core`) — _@deprecated; kept for adapter compatibility_:
- `id` (`string`) — UUID. NOT NULL.
- `filename` (`string`) — Original file name. NOT NULL.
- `mimeType` (`string`) — MIME type. NOT NULL.
- `size` (`number`) — File size in bytes. NOT NULL.
- `uploadedAt` (`number`) — Unix timestamp (ms). NOT NULL.
- `processed` (`boolean`) — Whether the document has been embedded. NOT NULL.
- `chunkCount?` (`number`) — Number of vector chunks.
- `error?` (`string`) — Processing error.

**`ArenaReference`** (imported from `@wave-client/core`):
- `id` (`string`) — Stable identifier. NOT NULL.
- `name` (`string`) — Display name. NOT NULL.
- `url` (`string`) — Full URL. NOT NULL.
- `description?` (`string`) — Shown in the UI.
- `category?` (`string`) — Grouping label.
- `type` (`ArenaSourceType`) — `'web'` | `'document'` | `'mcp'`. NOT NULL.
- `isDefault` (`boolean`) — Built-in references not removable by users. NOT NULL.
- `enabled` (`boolean`) — Whether the reference is active. NOT NULL.

**`ArenaProviderSettings`** / **`ArenaProviderSettingsMap`** (imported from `@wave-client/core`):
- `providerId` (`ArenaProviderType`) — NOT NULL.
- `enabled` (`boolean`) — User toggle. NOT NULL.
- `apiKey?` (`string`) — Cloud provider API key (plain-text per user decision).
- `apiUrl?` (`string`) — Custom base URL (Ollama).
- `disabledModels` (`string[]`) — User-disabled model IDs. NOT NULL, DEFAULT `[]`.

**`ArenaSettings`** (imported from `@wave-client/core`):
- `provider` (`ArenaProviderType`) — Active provider. NOT NULL.
- `model?` (`string`) — Active model override.
- `maxSessions` (`number`) — NOT NULL, DEFAULT `5`.
- `maxMessagesPerSession` (`number`) — NOT NULL, DEFAULT `10`.
- `maxDocumentSize` (`number`) — Deprecated field; kept for backward compat.
- `enableStreaming` (`boolean`) — NOT NULL, DEFAULT `true`.
- `customReferenceSites?` (`string[]`) — Custom reference URLs.

### Relationships

- `ArenaSession` 1:N `ArenaMessage` via `ArenaMessage.sessionId` (enforced by per-session JSON files)
- `ArenaDocument` is self-contained (no FK); deprecated; binary content stored separately

### Indexes & Constraints

No database indexes — flat JSON file storage. Uniqueness is enforced by the service layer:
- `ArenaSession.id` is unique within `sessions.json` (upsert replaces by `id`)
- `ArenaMessage.id` is unique within `messages/{sessionId}.json` (upsert replaces by `id`)
- `ArenaDocument.id` is unique within `documents.json` (upsert replaces by `id`)

### Storage Layout

```
{saveFilesLocation}/arena/
  sessions.json              ← ArenaSession[] (flat array, messages stored separately)
  messages/
    {sessionId}.json         ← ArenaMessage[] for a given session
  documents.json             ← ArenaDocument[] metadata only (deprecated)
  documents/
    {documentId}             ← raw binary content (Buffer)
  references.json            ← ArenaReference[] (user-added only; defaults merged at read time)
  provider-settings.json     ← ArenaProviderSettingsMap
  settings.json              ← ArenaSettings
```

Uses the `ARENA_DIR`, `ARENA_REFERENCES_FILE`, and `ARENA_PROVIDER_SETTINGS_FILE` constants from
`@wave-client/core` (`arenaConfig.ts`) rather than redefining them.

---

## 3. Files

- `packages/shared/src/services/ArenaStorageService.ts` — **Create** — the service class + singleton
- `packages/shared/src/services/index.ts` — **Update** — export `ArenaStorageService` and `arenaStorageService` singleton
- `packages/shared/src/test/services/ArenaStorageService.test.ts` — **Create** — unit tests

---

## 4. Dependencies

- `BaseStorageService` (already exists at `packages/shared/src/services/BaseStorageService.ts`) — `ArenaStorageService` extends it
- `@wave-client/core` Arena types (`ArenaSession`, `ArenaMessage`, `ArenaDocument`, `ArenaReference`, `ArenaSettings`, `ArenaProviderSettingsMap`, `getDefaultProviderSettings`, `DEFAULT_ARENA_SETTINGS`, `ARENA_DIR`, `ARENA_REFERENCES_FILE`, `ARENA_PROVIDER_SETTINGS_FILE`) — already a workspace dependency of `@wave-client/shared`

No other features need to be completed first. This feature has zero dependencies on Features 2–4.

---

## 5. Implementation Tasks

---

### TASK-001: Service scaffold + session persistence

- [ ] **Implementation**:
  Create `packages/shared/src/services/ArenaStorageService.ts`.

  The class extends `BaseStorageService` and uses a `private readonly subDir = ARENA_DIR` to
  locate its root directory. The arena directory is resolved as:
  ```
  {getAppDirFromSettings()}/arena/
  ```

  Add a private `getArenaDir()` helper (async, calls `getAppDirFromSettings()`) analogous to
  `CollectionService.getCollectionsDir()`. Call `ensureDirectoryExists(arenaDir)` inside every
  public method before use.

  Implement session persistence methods. `sessions.json` holds a flat `ArenaSession[]`.
  Upsert semantics: find by `id`, replace if found, push if not.

  ```typescript
  async loadSessions(): Promise<ArenaSession[]>    // reads sessions.json; returns [] on missing
  async saveSession(session: ArenaSession): Promise<void>      // upsert by id
  async deleteSession(sessionId: string): Promise<void>        // remove by id; also delete messages/{sessionId}.json
  ```

  `deleteSession` must also remove the associated messages file
  (`messages/{sessionId}.json`) if it exists.

  Use `readJsonFileSecure` / `writeJsonFileSecure` for `sessions.json` (matches the pattern
  used by other services; leverages optional encryption).

  Export singleton at the bottom of the file:
  ```typescript
  export const arenaStorageService = new ArenaStorageService();
  ```

- [ ] **Unit Tests**:
  File: `packages/shared/src/test/services/ArenaStorageService.test.ts`.

  Use the same `MockFileSystem` + `vi.mock('fs')` + `vi.mock('os')` pattern as
  `EnvironmentService.test.ts`. Set up `setGlobalSettingsProvider` and
  `setSecurityServiceInstance` with mocks in `beforeEach`.

  Key test cases:
  - `loadSessions()` returns `[]` when `sessions.json` does not exist (first run)
  - `saveSession()` creates `sessions.json` with the new session on first call
  - `saveSession()` upserts (replaces) an existing session with the same `id`
  - `saveSession()` appends a new session when no session with that `id` exists
  - `deleteSession()` removes the session from `sessions.json`
  - `deleteSession()` also removes `messages/{sessionId}.json` if it exists
  - `deleteSession()` is a no-op when `sessionId` does not exist (no throw)

- [ ] **Documentation Update**:
  Add JSDoc for the class and all three methods with `@param` and `@returns`.

- **Verify**: `pnpm --filter @wave-client/shared test` passes with the new test file.

---

### TASK-002: Message persistence

- [ ] **Implementation**:
  Add message persistence methods to `ArenaStorageService`.

  Messages for each session are stored as a flat `ArenaMessage[]` in
  `messages/{sessionId}.json`. The `messages/` subdirectory lives inside the arena dir.

  ```typescript
  async loadMessages(sessionId: string): Promise<ArenaMessage[]>
  async saveMessages(sessionId: string, messages: ArenaMessage[]): Promise<void>
  async clearSessionMessages(sessionId: string): Promise<void>  // deletes the file
  ```

  Implementation notes:
  - `loadMessages` returns `[]` when no file exists.
  - `saveMessages` uses `readJsonFileSecure` / `writeJsonFileSecure`.
  - `clearSessionMessages` uses `this.deleteFile(...)` on `messages/{sessionId}.json`.
  - The `messages/` subdirectory must be created with `ensureDirectoryExists` before
    any write.

  > Note: The `IArenaAdapter.saveMessage` method saves a **single** message. The `MessageHandler`
  > (Feature 3) is responsible for the merge: it calls `loadMessages`, upserts the single
  > message, then calls `saveMessages`. This service takes the full array for simplicity and
  > testability.

- [ ] **Unit Tests**:
  Extend `ArenaStorageService.test.ts` with a `describe('Message Persistence', ...)` block.

  Key test cases:
  - `loadMessages()` returns `[]` when file does not exist
  - `saveMessages()` creates `messages/{sessionId}.json` with the provided array
  - `saveMessages()` overwrites existing messages file with the new array
  - `loadMessages()` returns saved messages after `saveMessages()` 
  - `clearSessionMessages()` deletes the messages file
  - `clearSessionMessages()` is a no-op when file does not exist (no throw)

- [ ] **Documentation Update**:
  Add JSDoc for all three methods.

- **Verify**: New tests pass. `loadMessages` returns correct data after `saveMessages`.
- **Depends on**: TASK-001

---

### TASK-003: Settings, provider settings, and references persistence

- [ ] **Implementation**:
  Add three pairs of read/write methods to `ArenaStorageService`.

  **Arena Settings** (`settings.json`):
  ```typescript
  async loadSettings(): Promise<ArenaSettings>
  async saveSettings(settings: ArenaSettings): Promise<void>
  ```
  File: `{arenaDir}/settings.json`. Default on missing file: `DEFAULT_ARENA_SETTINGS` (from
  `@wave-client/core`).

  **Provider Settings** (`provider-settings.json`):
  ```typescript
  async loadProviderSettings(): Promise<ArenaProviderSettingsMap>
  async saveProviderSettings(settings: ArenaProviderSettingsMap): Promise<void>
  ```
  File: `{arenaDir}/provider-settings.json`. Default on missing file:
  `getDefaultProviderSettings()` (from `@wave-client/core`).
  Use `readJsonFileSecure` / `writeJsonFileSecure` — this file may contain API keys.

  **References** (`references.json`):
  ```typescript
  async loadReferences(): Promise<ArenaReference[]>
  async saveReferences(references: ArenaReference[]): Promise<void>
  ```
  File: `{arenaDir}/references.json`. Default on missing file: `[]` (empty array).
  Only user-added (non-default) references are persisted; merging with defaults happens
  in the adapter/UI via `mergeReferences()`. This service stores and returns the raw
  user list only.

  Use the constants `ARENA_REFERENCES_FILE` and `ARENA_PROVIDER_SETTINGS_FILE` from
  `@wave-client/core` for file names. Use a local constant `ARENA_SETTINGS_FILE = 'settings.json'`
  for the settings file (it does not have a constant in `arenaConfig.ts` yet).

- [ ] **Unit Tests**:
  Extend `ArenaStorageService.test.ts` with `describe('Settings Persistence', ...)`,
  `describe('Provider Settings Persistence', ...)`, and `describe('References Persistence', ...)`
  blocks.

  Key test cases:
  - `loadSettings()` returns `DEFAULT_ARENA_SETTINGS` when file is missing
  - `saveSettings()` / `loadSettings()` round-trips correctly (data survives serialisation)
  - Partial settings object merges correctly (spread with `DEFAULT_ARENA_SETTINGS` as base)
  - `loadProviderSettings()` returns `getDefaultProviderSettings()` when file is missing
  - `saveProviderSettings()` / `loadProviderSettings()` round-trips correctly
  - API key survives the round-trip (is not stripped or redacted)
  - `loadReferences()` returns `[]` when file is missing
  - `saveReferences()` / `loadReferences()` round-trips correctly

- [ ] **Documentation Update**:
  Add JSDoc for all six methods. Note the `@deprecated` status of `ArenaDocument`-related
  methods in the class-level JSDoc to guide future removal.

- **Verify**: All new unit tests pass.
- **Depends on**: TASK-001

---

### TASK-004: Document metadata and binary content storage

- [ ] **Implementation**:
  Add document-related methods to `ArenaStorageService`.

  > **Note**: `ArenaDocument` is `@deprecated` in `@wave-client/core`. These methods are
  > implemented only because `IArenaAdapter.uploadDocument` / `loadDocuments` / `deleteDocument`
  > are still part of the adapter interface. They will be removed when the adapter interface
  > is cleaned up in a future plan.

  Document metadata is stored as a flat `ArenaDocument[]` at `{arenaDir}/documents.json`.
  Binary content is stored at `{arenaDir}/documents/{documentId}` (no extension — raw bytes).

  ```typescript
  async loadDocuments(): Promise<ArenaDocument[]>
  async saveDocumentMetadata(document: ArenaDocument): Promise<void>   // upsert by id
  async deleteDocument(documentId: string): Promise<void>              // removes from list + deletes binary file
  async loadDocumentContent(documentId: string): Promise<Buffer>
  async saveDocumentContent(documentId: string, content: Buffer): Promise<void>
  ```

  `loadDocumentContent` and `saveDocumentContent` bypass `readJsonFileSecure` and use
  `fs.readFileSync(filePath)` / `fs.writeFileSync(filePath, content)` directly, since the
  content is binary (not JSON).

  `deleteDocument` should:
  1. Remove the document from the `documents.json` array by `id`.
  2. Delete the binary file at `documents/{documentId}` if it exists (use `this.deleteFile`).

- [ ] **Unit Tests**:
  Extend `ArenaStorageService.test.ts` with a `describe('Document Storage', ...)` block.
  Update the `vi.mock('fs')` factory (at the top of the test file) to include
  `readFileSync` returning a `Buffer` for non-text paths (or handle both text and binary).

  Key test cases:
  - `loadDocuments()` returns `[]` when `documents.json` is missing
  - `saveDocumentMetadata()` upserts — replaces by `id`, appends new
  - `deleteDocument()` removes document from metadata list
  - `deleteDocument()` deletes the binary file if it exists
  - `deleteDocument()` does not throw when document is not in the list
  - `saveDocumentContent()` writes binary data to `documents/{id}`
  - `loadDocumentContent()` reads and returns the same buffer that was saved

- [ ] **Documentation Update**:
  Add JSDoc for all five methods, each with an `@deprecated` note pointing to the future
  removal plan.

- **Verify**: All new unit tests pass.
- **Depends on**: TASK-001

---

### TASK-005: Export `arenaStorageService` from shared package index

- [ ] **Implementation**:
  Update `packages/shared/src/services/index.ts` to export the new service:

  ```typescript
  export {
      ArenaStorageService,
      arenaStorageService,
  } from './ArenaStorageService';
  ```

  Add it below the existing service exports, before the auth export block.

- [ ] **Unit Tests**:
  No new test cases required. Verify the export is accessible by running the TypeScript
  compiler: the build must succeed with `pnpm --filter @wave-client/shared build` (or
  `typecheck`).

- [ ] **Documentation Update**:
  Add a single-line JSDoc comment to the export in `index.ts` noting its purpose.

- **Verify**: `pnpm --filter @wave-client/shared build` exits zero. The `arenaStorageService`
  symbol is importable from `@wave-client/shared` in a downstream package.
- **Depends on**: TASK-001, TASK-002, TASK-003, TASK-004

---

## 6. Cross-Cutting Concerns

- **Auth**: N/A — this service manages local file I/O only; no authentication required.

- **Error Handling**: Follow the `BaseStorageService` precedent:
  - Missing files → return the documented default value (never throw).
  - Unexpected FS errors (permissions, disk full) → re-throw after logging with `console.error`
    including the file path and operation name, so the extension host catches them and surfaces
    an error to the user.
  - Do NOT use the `Result<T, E>` pattern in this service — the service layer throws; the
    `MessageHandler` wraps in try/catch and returns a `Result`-shaped postMessage (consistent
    with how all other services are consumed in `MessageHandler.ts`).

- **Logging**: Log all unexpected FS read/write errors at `console.error` level with the file
  path and operation name. Never log the contents of `provider-settings.json` or any field
  that may contain an API key.

---

## 7. State Tracking

- [x] TASK-001: Service scaffold + session persistence
- [x] TASK-002: Message persistence
- [x] TASK-003: Settings, provider settings, and references persistence
- [x] TASK-004: Document metadata and binary content storage
- [x] TASK-005: Export arenaStorageService from shared package index

Legend: [ ] Not started | [/] In progress | [x] Completed
